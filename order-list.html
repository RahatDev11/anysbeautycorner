<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অর্ডার লিস্ট - Any's Beauty Corner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* General Styles */
        body { font-family: 'Arial', sans-serif; }
        .bg-lipstick { background-color: #A52A2A; }
        .text-lipstick { color: #A52A2A; }
        .border-lipstick { border-color: #A52A2A; }
        .hover\:bg-lipstick-dark:hover { background-color: #8B1A1A; }
        .bg-background { background-color: #FFF5F7; }

        /* Table Styles */
        .table-container {
            overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;
            border: 1px solid #e2e8f0; border-radius: 0.375rem;
        }
        .order-table { width: 100%; min-width: 650px; border-collapse: collapse; }
        
        /* ডিফল্ট (মোবাইল এবং ছোট স্ক্রিনের জন্য) টেবিল ফন্ট সাইজ */
        .order-table th, 
        .order-table td {
            padding: 0.6rem 0.4rem; 
            text-align: left; 
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.8rem; /* মোবাইল ও ছোট স্ক্রিনের জন্য ডিফল্ট */
            white-space: nowrap;
        }
        .order-table th:first-child, .order-table td:first-child { padding-left: 0.75rem; }
        .order-table th:last-child, .order-table td:last-child { padding-right: 0.75rem; }

        .order-table th.product-col, 
        .order-table td.product-col {
            white-space: normal; 
            min-width: 130px; /* মোবাইলের জন্য */
            max-width: 220px; /* মোবাইলের জন্য */
        }
        .order-table th { 
            background: #f8fafc; 
            font-weight: 600; 
            color: #374151; 
            text-transform: uppercase; 
            font-size: 0.75rem; /* মোবাইল ও ছোট স্ক্রিনের জন্য হেডার */
        }
        .order-table td { color: #1f2937; }
        .order-table tr:last-child td { border-bottom: none; }
        
        .clickable-row { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .clickable-row:hover { background-color: #eff6ff; }
        .order-table th.time-col, .order-table td.time-col { 
            min-width: 90px; /* মোবাইলের জন্য */
            text-align: right; 
        }
        .order-table th.status-col, .order-table td.status-col { text-align: center; }

        /* ডেস্কটপ ভিউয়ের জন্য টেবিলের ফন্ট সাইজ ও অন্যান্য স্টাইল বড় করা */
        @media (min-width: 768px) { /* 768px বা তার চেয়ে বড় স্ক্রিনের জন্য (md breakpoint in Tailwind) */
            .order-table th, 
            .order-table td {
                font-size: 0.95rem; /* ডেস্কটপের জন্য বড় ফন্ট সাইজ */
                padding: 0.8rem 0.6rem; /* ডেস্কটপের জন্য প্যাডিং */
            }

            .order-table th {
                font-size: 0.9rem;  /* ডেস্কটপের জন্য টেবিল হেডারের ফন্ট সাইজ */
            }
            
            .order-table th.product-col,
            .order-table td.product-col {
                min-width: 200px; /* ডেস্কটপের জন্য প্রোডাক্ট কলামের ন্যূনতম প্রস্থ */
                max-width: 350px; /* ডেস্কটপের জন্য প্রোডাক্ট কলামের সর্বোচ্চ প্রস্থ */
            }
            .order-table th.time-col,
            .order-table td.time-col {
                min-width: 120px; /* ডেস্কটপের জন্য সময় কলামের ন্যূনতম প্রস্থ */
            }
        }


        /* Status Colors */
        .status-processing { color: #D97706; font-weight: 500; }
        .status-confirmed { color: #2563EB; font-weight: 500; }
        .status-packaging { color: #7C3AED; font-weight: 500; }
        .status-shipped { color: #1D4ED8; font-weight: 500; }
        .status-delivered { color: #16A34A; font-weight: 500; }
        .status-failed { color: #DC2626; font-weight: 500; }
        .status-cancelled { color: #6B7280; font-weight: 500; }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1000; 
            justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem; max-width: 100%;
            width: 550px; max-height: 90vh; overflow-y: auto; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            font-size: 0.95rem; /* ডেস্কটপের জন্য ডিফল্ট */
        }
        .modal-close {
            position: absolute; top: 0.75rem; right: 0.75rem; font-size: 1.5rem;
            color: #9ca3af; cursor: pointer; transition: color 0.2s;
        }
        .modal-close:hover { color: #A52A2A; }

        /* Modal Inner Content Font Sizes (Desktop Default) */
        #captureSection p,
        .cart-item-details p,
        .timeline-content p {
            font-size: 0.9rem; 
            line-height: 1.5;
        }
         #captureSection p strong { font-weight: 600; }
        .cart-item-details p.font-medium { font-size: 0.95rem; font-weight: 500; }
        .modal-content h3 { font-size: 1.25rem; }
        .modal-content h4 { font-size: 1.05rem; margin-bottom: 0.5rem; }
        .timeline-content .text-xs { font-size: 0.8rem; }

        /* Capture Section */
        #captureSection { padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 1rem; }
        #captureSection p { margin-bottom: 0.4rem; }

        /* Cart Items in Modal */
        .cart-items { margin-bottom: 1.5rem; }
        .cart-item { display: flex; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid #e2e8f0; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item img { width: 45px; height: 45px; object-fit: cover; border-radius: 0.25rem; margin-right: 0.85rem;}
        .cart-item-details { flex: 1; }

        /* Login Message */
        .login-message-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-message-box {
            background: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; text-align: center;
        }

        /* Form Elements in Modal */
        .status-select, .update-btn, .save-btn { font-size: 0.9rem; padding: 0.5rem 0.8rem; border-radius: 0.375rem; cursor: pointer; }
        .status-select { border: 1px solid #d1d5db; background: white; color: #1f2937; }
        .update-btn { background: #A52A2A; color: white; border: none; transition: background-color 0.3s ease; }
        .update-btn:hover { background: #8B1A1A; }
        .save-btn { background: #16A34A; color: white; border: none; transition: background-color 0.3s ease; margin-top: 1rem; display: block; width: 100%; }
        .save-btn:hover { background: #13863C; }
        textarea.admin-note-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; width: 100%; font-size: 0.9rem; }

        /* Timeline */
        .timeline { position: relative; padding-left: 1.5rem; margin-top: 1rem; }
        .timeline-item { position: relative; margin-bottom: 0.75rem; }
        .timeline-item::before {
            content: ''; position: absolute; left: -1.125rem;
            top: 0.125rem; width: 2px; height: calc(100% - 0.25rem); background: #e2e8f0;
        }
        .timeline-item:last-child::before { height: 0; }
        .timeline-dot {
            position: absolute; left: -1.5rem; top: 0;
            width: 0.75rem; height: 0.75rem; background: #A52A2A; border-radius: 50%;
            border: 2px solid white;
        }
        .timeline-content { background: #f8fafc; padding: 0.6rem 0.85rem; border-radius: 0.375rem; border: 1px solid #e5e7eb;}

        /* Loading Spinner */
        .loading-spinner { display: none; text-align: center; padding: 2rem 1rem; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #A52A2A; border-radius: 50%;
            width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Filter Controls */
        .filter-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; align-items: center; }
        .filter-controls input[type="text"], .filter-controls select {
            border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.85rem; flex-grow: 1;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .filter-controls input[type="text"] { flex-grow: 2; }
            .filter-controls select { flex-grow: 1; }
        }
        #toast-notification { z-index: 2000 !important; }
        .todays-order-count {
            font-size: 0.9rem; color: #4B5563; margin-left: 0.75rem;
            background-color: #F3F4F6; padding: 0.25rem 0.6rem;
            border-radius: 0.375rem; font-weight: 500;
        }

        /* Mobile Specific Font Sizes for Modal */
        @media (max-width: 767px) {
            .modal-content {
                font-size: 0.85rem; 
                padding: 1rem; 
            }
            #captureSection p,
            .cart-item-details p,
            .timeline-content p {
                font-size: 0.8rem; 
                line-height: 1.4;
            }
             #captureSection p strong { font-weight: 500; }
            .cart-item-details p.font-medium { font-size: 0.85rem; }
            .modal-content h3 { font-size: 1.1rem; }
            .modal-content h4 { font-size: 0.95rem; }
            .timeline-content .text-xs { font-size: 0.75rem; }
            .status-select, .update-btn, .save-btn { font-size: 0.8rem; padding: 0.4rem 0.7rem; }
            textarea.admin-note-input { font-size: 0.8rem; }
            .cart-item img { width: 35px; height: 35px; margin-right: 0.5rem;}
        }
    </style>
</head>
<body class="bg-background">
    <div id="header"></div>

    <div id="loginMessageContainer" class="login-message-container hidden">
        <div class="login-message-box">
            <h2 class="text-xl font-bold text-center mb-4 text-lipstick">এডমিন লগইন প্রয়োজন</h2>
            <p class="text-gray-700">এই পেজে অ্যাক্সেস করতে লগইন করুন।</p>
        </div>
    </div>

    <main id="mainContent" class="p-4 pt-20 hidden">
        <div class="bg-white/20 backdrop-blur-md border border-white/30 rounded-lg shadow-lg p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h2 class="text-xl font-bold text-lipstick">অর্ডার লিস্ট</h2>
                    <span id="todaysOrderCount" class="todays-order-count">আজকের অর্ডার: ০</span>
                </div>
                <button id="logoutBtn" class="bg-lipstick text-white px-3 py-1.5 rounded-md text-sm hover:bg-lipstick-dark">
                    লগআউট
                </button>
            </div>
            
            <div class="filter-controls">
                <input type="text" id="searchInput" placeholder="কাস্টমারের নাম দিয়ে সার্চ করুন...">
                <select id="statusFilter">
                    <option value="">সব স্ট্যাটাস</option>
                    <option value="processing">প্রসেসিং</option>
                    <option value="confirmed">কনফার্মড</option>
                    <option value="packaging">প্যাকেজিং</option>
                    <option value="shipped">ডেলিভারি হয়েছে</option>
                    <option value="delivered">সম্পন্ন হয়েছে</option>
                    <option value="failed">ব্যর্থ</option>
                    <option value="cancelled">ক্যানসেলড</option>
                </select>
                <select id="dateFilter">
                    <option value="today">আজকের অর্ডার</option>
                    <option value="yesterday">গতকালের অর্ডার</option>
                    <option value="this_week">এই সপ্তাহের</option>
                    <option value="this_month">এই মাসের</option>
                    <option value="last_month">গত মাসের</option>
                    <option value="all">সব অর্ডার</option>
                </select>
            </div>
            
            <div class="table-container">
                <table class="order-table hidden" id="orderTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>কাস্টমার</th>
                            <th class="product-col">প্রোডাক্ট</th>
                            <th class="status-col">স্ট্যাটাস</th>
                            <th class="time-col">সময়</th>
                        </tr>
                    </thead>
                    <tbody id="orderList"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <div id="orderModal" class="modal">
        <div class="modal-content" id="modalContentWrapper">
            <span id="modalClose" class="modal-close">×</span>
            <h3 class="font-bold mb-3 text-lipstick">অর্ডারের বিস্তারিত</h3>
            <div id="modalContent"></div>
            <button id="saveModalBtn" class="save-btn">ইনভয়েস ডাউনলোড</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // WARNING: It is recommended to store these keys in environment variables.
        // You can use Netlify's build environment variables for this.
        const firebaseConfig = {
            apiKey: "AIzaSyCVSzQS1c7H4BLhsDF_fW8wnqUN4B35LPA",
            authDomain: "nahid-6714.firebaseapp.com",
            databaseURL: "https://nahid-6714-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nahid-6714",
            storageBucket: "nahid-6714.appspot.com",
            messagingSenderId: "505741217147",
            appId: "1:505741217147:web:25ed4e9f0d00e3c4d381de",
            measurementId: "G-QZ7CTRKHCW"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        let allOrders = [];
        let orderSerialNumberMap = {}; // ক্রমিক নম্বর ম্যাপ করার জন্য 

        document.addEventListener("DOMContentLoaded", function() {
            $("#header").load("header.html", (response, status, xhr) => {
                if (status === "error") console.error("Header load error:", xhr.status, xhr.statusText);
            });
            $("#footer").load("footer.html", (response, status, xhr) => {
                if (status === "error") console.error("Footer load error:", xhr.status, xhr.statusText);
            });
            checkAuthState();
        });

        function showToast(message, type = 'success') {
            const toastId = 'toast-notification';
            let toast = document.getElementById(toastId);
            if (toast) toast.remove();

            toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-md shadow-lg text-sm ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;
            toast.classList.add('z-[2000]');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }
        
        async function sendNotificationToCustomer(userId, title, body) {
            try {
                const userRef = ref(database, `users/${userId}`);
                const snapshot = await get(userRef);
                const userData = snapshot.val();

                if (!userData || !userData.fcmToken) {
                    console.log(`FCM token for user ${userId} not found. Notification not sent.`);
                    return;
                }
                const fcmToken = userData.fcmToken;

                const response = await fetch('/.netlify/functions/fcm_notifier', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fcmToken: fcmToken,
                        title: title,
                        body: body,
                        click_action: window.location.origin + '/my-orders.html'
                    })
                });

                if (response.ok) {
                    showToast("কাস্টমারকে নোটিফিকেশন পাঠানো হয়েছে।");
                } else {
                    const errorData = await response.json();
                    console.error("FCM send error:", errorData);
                    showToast("নোটিফিকেশন পাঠাতে সমস্যা হয়েছে।", 'error');
                }
            } catch (error) {
                console.error("Error sending FCM notification:", error);
                showToast("নোটিফিকেশন পাঠাতে ত্রুটি হয়েছে।", 'error');
            }
        }

        function checkAuthState() {
            const loginMessageContainer = document.getElementById('loginMessageContainer');
            const mainContent = document.getElementById('mainContent');
            onAuthStateChanged(auth, (user) => {
                if (user && user.email === 'mdnahidislam6714@gmail.com') {
                    loginMessageContainer.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    loadOrders();
                } else {
                    if (user) signOut(auth);
                    loginMessageContainer.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    if (user) showToast('শুধুমাত্র এডমিন এই পেজ অ্যাক্সেস করতে পারবে।', 'error');
                }
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => showToast('সফলভাবে লগআউট করা হয়েছে।', 'success'))
                         .catch(error => showToast(`লগআউট সমস্যা: ${error.message}`, 'error'));
        });

        function loadOrders() {
            const ordersRef = ref(database, 'orders');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const orderTable = document.getElementById('orderTable');

            if (loadingSpinner) loadingSpinner.style.display = 'block';
            orderTable.classList.add('hidden');

            onValue(ordersRef, (snapshot) => {
                allOrders = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const order = childSnapshot.val();
                        order.key = childSnapshot.key;
                        if (order && typeof order.customerName === 'string' && typeof order.orderDate === 'string') {
                             allOrders.push(order);
                        } else {
                            console.warn("অর্ডারে customerName বা orderDate নেই, বাদ দেওয়া হলো:", order.key, order);
                        }
                    });
                }
                // Display order: Newest on top
                allOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)); 
                
                filterAndDisplayOrders();
                
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                // Check if orderList has content, not just allOrders.length, because filters might result in empty list
                const orderListEl = document.getElementById('orderList');
                if (orderListEl.innerHTML.includes('clickable-row')) { // A bit of a hack, better to check filtered list length
                    orderTable.classList.remove('hidden');
                } else if (allOrders.length === 0) { // No orders at all
                     orderListEl.innerHTML = `<tr><td colspan="5" class="text-center text-gray-600 py-6">এখনও কোনো অর্ডার পাওয়া যায়নি।</td></tr>`;
                     orderTable.classList.remove('hidden');
                } else { // Orders exist, but current filter shows none
                     orderTable.classList.remove('hidden'); // Keep table visible to show "no orders in filter"
                }
            }, (error) => {
                console.error("অর্ডার লোড করতে সমস্যা:", error);
                showToast("অর্ডার লোড করতে সমস্যা হয়েছে।", 'error');
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                const orderListEl = document.getElementById('orderList');
                orderListEl.innerHTML = `<tr><td colspan="5" class="text-center text-red-600 py-6">অর্ডার লোড করা যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।</td></tr>`;
                orderTable.classList.remove('hidden');
            });
        }
        
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `${seconds} সে. আগে`;
            if (minutes < 60) return `${minutes} মি. আগে`;
            if (hours < 24) return `${hours} ঘ. আগে`;
            if (days === 1) return 'গতকাল';
            if (days < 7) return `${days} দিন আগে`;
            return date.toLocaleDateString('bn-BD', { day: '2-digit', month: 'short' });
        }

        function displayOrders(ordersToDisplay) {
            const orderListEl = document.getElementById('orderList');
            orderListEl.innerHTML = '';

            if (ordersToDisplay.length === 0) {
                orderListEl.innerHTML = `<tr><td colspan="5" class="text-center text-gray-600 py-6">এই ফিল্টারে কোনো অর্ডার পাওয়া যায়নি।</td></tr>`;
                return;
            }

            // ordersToDisplay is already sorted newest first by filterAndDisplayOrders
            ordersToDisplay.forEach((order) => {
                const productNames = (order.cartItems && order.cartItems.length > 0) 
                    ? order.cartItems.map(item => item.name).join(', ') 
                    : 'N/A';
                const currentStatus = order.status || 'processing';
                
                const serialNumber = orderSerialNumberMap[order.key] || '-';

                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.setAttribute('data-order-id', order.key);
                
                row.innerHTML = `
                    <td>${serialNumber}</td>
                    <td>${order.customerName}</td>
                    <td class="product-col">${productNames.substring(0, 50)}${productNames.length > 50 ? '...' : ''}</td>
                    <td class="status-col status-${currentStatus}">${getStatusText(currentStatus)}</td>
                    <td class="time-col">${formatTimeAgo(order.orderDate)}</td>
                `;
                orderListEl.appendChild(row);
                row.addEventListener('click', function() { showOrderDetails(this.dataset.orderId); });
            });
        }

        document.getElementById('searchInput').addEventListener('input', filterAndDisplayOrders);
        document.getElementById('statusFilter').addEventListener('change', filterAndDisplayOrders);
        document.getElementById('dateFilter').addEventListener('change', filterAndDisplayOrders);

        function filterAndDisplayOrders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilterValue = document.getElementById('statusFilter').value;
            const dateFilterValue = document.getElementById('dateFilter').value;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            let actualTodaysCount = 0; // Count today's orders from allOrders
            allOrders.forEach(order => {
                const orderDateOnly = new Date(new Date(order.orderDate).getFullYear(), new Date(order.orderDate).getMonth(), new Date(order.orderDate).getDate());
                if (orderDateOnly.getTime() === today.getTime()) {
                    actualTodaysCount++;
                }
            });
            const todaysOrderCountEl = document.getElementById('todaysOrderCount');
            if (todaysOrderCountEl) {
                todaysOrderCountEl.textContent = `আজকের অর্ডার: ${actualTodaysCount}`;
            }

            let filteredForDisplay = allOrders.filter(order => { // Filter for display (newest first)
                const orderDateOnly = new Date(new Date(order.orderDate).getFullYear(), new Date(order.orderDate).getMonth(), new Date(order.orderDate).getDate());
                const matchesSearch = order.customerName.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilterValue ? (order.status || 'processing') === statusFilterValue : true;
                let matchesDate = true;
                if (dateFilterValue === 'today') matchesDate = orderDateOnly.getTime() === today.getTime();
                else if (dateFilterValue === 'yesterday') {
                    const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                    matchesDate = orderDateOnly.getTime() === yesterday.getTime();
                } else if (dateFilterValue === 'this_week') {
                    const firstDay = new Date(today); firstDay.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                    const lastDay = new Date(firstDay); lastDay.setDate(firstDay.getDate() + 6);
                    matchesDate = orderDateOnly >= firstDay && orderDateOnly <= lastDay;
                } else if (dateFilterValue === 'this_month') {
                    matchesDate = orderDateOnly.getFullYear() === today.getFullYear() && orderDateOnly.getMonth() === today.getMonth();
                } else if (dateFilterValue === 'last_month') {
                    const firstDayLM = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastDayLM = new Date(today.getFullYear(), today.getMonth(), 0);
                    matchesDate = orderDateOnly >= firstDayLM && orderDateOnly <= lastDayLM;
                }
                return matchesSearch && matchesStatus && matchesDate;
            });

            // Create serial numbers based on the filtered list, sorted oldest first for serializing
            const ordersForSerializing = [...filteredForDisplay].sort((a, b) => new Date(a.orderDate) - new Date(b.orderDate));
            
            orderSerialNumberMap = {}; 
            ordersForSerializing.forEach((order, index) => {
                orderSerialNumberMap[order.key] = index + 1;
            });
            
            displayOrders(filteredForDisplay); // Display the list that's already sorted newest first
        }
        
        async function updateOrderStatus(orderId) {
            const selectEl = document.querySelector(`#statusSelect-${orderId}`);
            if (!selectEl) { showToast("স্ট্যাটাস এলিমেন্ট নেই।", 'error'); return; }
            const newStatus = selectEl.value;
            const orderRef = ref(database, `orders/${orderId}`);
            const currentOrder = allOrders.find(o => o.key === orderId);
            if (!currentOrder) { showToast("অর্ডার নেই।", 'error'); return; }
            const statusHistory = currentOrder.statusHistory || [];
            statusHistory.push({ status: newStatus, updatedAt: new Date().toISOString() });

            try {
                await update(orderRef, { status: newStatus, statusHistory: statusHistory });
                showToast('স্ট্যাটাস আপডেট হয়েছে।');
                showOrderDetails(orderId);
                if (currentOrder.userId && currentOrder.orderId) {
                    const title = "অর্ডার স্ট্যাটাস আপডেট";
                    const body = `আপনার অর্ডার (ID: ${currentOrder.orderId}) এর স্ট্যাটাস: ${getStatusText(newStatus)}`;
                    await sendNotificationToCustomer(currentOrder.userId, title, body);
                }
            } catch (error) {
                console.error("স্ট্যাটাস আপডেট সমস্যা:", error);
                showToast(`স্ট্যাটাস আপডেট সমস্যা: ${error.message}`, 'error');
            }
        }
        
        async function addAdminNote(orderId) {
            const noteInputEl = document.querySelector(`#adminNote-${orderId}`);
            const newNote = noteInputEl.value.trim();
            if (!newNote) { showToast("নোট লিখুন।", 'error'); return; }
            const orderRef = ref(database, `orders/${orderId}`);
            const currentOrder = allOrders.find(o => o.key === orderId);
            const adminNotes = currentOrder.adminNotes || [];
            adminNotes.push({ note: newNote, addedAt: new Date().toISOString() });
            try {
                await update(orderRef, { adminNotes: adminNotes });
                showToast('নোট যোগ করা হয়েছে।');
                noteInputEl.value = '';
                showOrderDetails(orderId);
            } catch (error) {
                console.error("নোট যোগ সমস্যা:", error);
                showToast("নোট যোগ করতে সমস্যা।", 'error');
            }
        }

        function showOrderDetails(orderId) {
            const orderRef = ref(database, `orders/${orderId}`);
            const modal = document.getElementById('orderModal');
            const modalContentEl = document.getElementById('modalContent');
            const modalClose = document.getElementById('modalClose');
            const saveModalBtn = document.getElementById('saveModalBtn');

            const newModalClose = modalClose.cloneNode(true);
            modalClose.parentNode.replaceChild(newModalClose, modalClose);
            const newSaveModalBtn = saveModalBtn.cloneNode(true);
            saveModalBtn.parentNode.replaceChild(newSaveModalBtn, saveModalBtn);
            
            newModalClose.addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

            onValue(orderRef, (snapshot) => {
                const order = snapshot.val();
                if (order) {
                    let captureHTML = `
                        <div id="captureSection">
                            <h4 class="font-semibold mb-2 text-lipstick">ইনভয়েস</h4>
                            <p><strong>নাম:</strong> ${order.customerName || 'N/A'}</p>
                            <p><strong>ইমেইল:</strong> ${order.userEmail || 'N/A'}</p>
                            <p><strong>ফোন:</strong> ${order.phoneNumber || 'N/A'}</p>
                            <p><strong>ঠিকানা:</strong> ${order.address || 'N/A'}</p>
                            <p><strong>ডেলিভারি:</strong> ${order.deliveryLocation === 'insideDhaka' ? 'ঢাকার ভেতরে' : 'ঢাকার বাইরে'} ${order.outsideDhakaLocation ? `(${order.outsideDhakaLocation})` : ''}</p>
                            ${order.deliveryNote ? `<p><strong>ডেলিভারি নোট:</strong> ${order.deliveryNote}</p>` : ''}
                            <hr class="my-1.5">
                            <p><strong>পণ্য পেমেন্ট:</strong> ${order.productPaymentMethod === 'cod' ? 'ক্যাশ অন ডেলিভারি' : (order.productPaymentMethod || 'N/A')}</p>
                            ${order.deliveryPaymentMethod && order.deliveryLocation === 'outsideDhaka' ? `<p><strong>ডেলিভারি চার্জ পেমেন্ট:</strong> ${order.deliveryPaymentMethod}</p>` : ''}
                            ${order.paymentNumber && order.deliveryLocation === 'outsideDhaka' ? `<p><strong>পেমেন্ট নম্বর:</strong> ${order.paymentNumber}</p>` : ''}
                            <p><strong>ডেলিভারি ফি:</strong> ${order.deliveryFee || 0} টাকা</p>
                            <p><strong>মোট মূল্য:</strong> ${order.totalAmount || 0} টাকা</p>
                            <hr class="my-1.5">
                            <p><strong>অর্ডার আইডি:</strong> ${order.orderId || 'N/A'}</p>
                            <p><strong>অর্ডারের তারিখ:</strong> ${new Date(order.orderDate).toLocaleString('bn-BD', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                            <p><strong>বর্তমান স্ট্যাটাস:</strong> <span class="status-${order.status || 'processing'}">${getStatusText(order.status || 'processing')}</span></p>
                        </div>`;

                    let nonCaptureHTML = '';
                    const currentStatus = order.status || 'processing';
                    nonCaptureHTML += `
                        <div class="mt-3">
                            <h4 class="font-semibold mb-1.5 text-lipstick">স্ট্যাটাস আপডেট</h4>
                            <div class="flex items-center gap-2">
                                <select id="statusSelect-${orderId}" class="status-select flex-grow">
                                    <option value="processing" ${currentStatus === 'processing' ? 'selected' : ''}>প্রসেসিং</option>
                                    <option value="confirmed" ${currentStatus === 'confirmed' ? 'selected' : ''}>কনফার্মড</option>
                                    <option value="packaging" ${currentStatus === 'packaging' ? 'selected' : ''}>প্যাকেজিং</option>
                                    <option value="shipped" ${currentStatus === 'shipped' ? 'selected' : ''}>ডেলিভারি হয়েছে</option>
                                    <option value="delivered" ${currentStatus === 'delivered' ? 'selected' : ''}>সম্পন্ন হয়েছে</option>
                                    <option value="failed" ${currentStatus === 'failed' ? 'selected' : ''}>ব্যর্থ</option>
                                    <option value="cancelled" ${currentStatus === 'cancelled' ? 'selected' : ''}>ক্যানসেলড</option>
                                </select>
                                <button class="update-btn" data-order-id="${orderId}">আপডেট</button>
                            </div>
                        </div>`;

                    if (order.statusHistory && order.statusHistory.length > 0) {
                        nonCaptureHTML += `<div class="mt-3"><h4 class="font-semibold mb-1.5 text-lipstick">স্ট্যাটাস টাইমলাইন</h4><div class="timeline">`;
                        order.statusHistory.slice().reverse().forEach(history => {
                            nonCaptureHTML += `
                                <div class="timeline-item">
                                    <div class="timeline-dot"></div>
                                    <div class="timeline-content">
                                        <p><strong>স্ট্যাটাস:</strong> <span class="status-${history.status}">${getStatusText(history.status)}</span></p>
                                        <p class="text-xs text-gray-500">সময়: ${new Date(history.updatedAt).toLocaleString('bn-BD', { dateStyle: 'short', timeStyle: 'short' })}</p>
                                    </div>
                                </div>`;
                        });
                        nonCaptureHTML += '</div></div>';
                    }

                    nonCaptureHTML += `
                        <div class="mt-3">
                            <h4 class="font-semibold mb-1.5 text-lipstick">এডমিন নোট</h4>
                            <textarea id="adminNote-${orderId}" class="admin-note-input" rows="2" placeholder="এখানে নোট লিখুন..."></textarea>
                            <button class="update-btn mt-1.5 text-xs px-3 py-1" data-order-id="${orderId}" data-action="add-note">নোট যোগ করুন</button>
                        </div>`;

                    if (order.adminNotes && order.adminNotes.length > 0) {
                        nonCaptureHTML += `<div class="mt-3"><h4 class="font-semibold mb-1.5 text-lipstick">এডমিন নোটসমূহ</h4><div class="timeline">`;
                        order.adminNotes.slice().reverse().forEach(note => {
                            nonCaptureHTML += `
                                <div class="timeline-item">
                                    <div class="timeline-dot"></div>
                                    <div class="timeline-content">
                                        <p>${note.note}</p>
                                        <p class="text-xs text-gray-500">সময়: ${new Date(note.addedAt).toLocaleString('bn-BD', { dateStyle: 'short', timeStyle: 'short' })}</p>
                                    </div>
                                </div>`;
                        });
                        nonCaptureHTML += '</div></div>';
                    }
                    
                    nonCaptureHTML += '<h4 class="font-semibold mt-3 mb-1.5 text-lipstick">অর্ডার করা প্রোডাক্ট</h4>';
                    nonCaptureHTML += '<div class="cart-items">';
                    if (order.cartItems && order.cartItems.length > 0) {
                        order.cartItems.forEach(item => {
                            const imageUrl = item.image ? item.image.split(',')[0].trim() : 'https://via.placeholder.com/40';
                            nonCaptureHTML += `
                                <div class="cart-item">
                                    <img src="${imageUrl}" alt="${item.name || 'Product'}" onerror="this.src='https://via.placeholder.com/40';">
                                    <div class="cart-item-details">
                                        <p class="font-medium">${item.name || 'N/A'}</p>
                                        <p>মূল্য: ${item.price || 0} টাকা, পরিমাণ: ${item.quantity || 0}</p>
                                    </div>
                                </div>`;
                        });
                    } else {
                        nonCaptureHTML += '<p class="text-gray-600">কোনো প্রোডাক্ট সিলেক্ট করা হয়নি।</p>';
                    }
                    nonCaptureHTML += '</div>';

                    modalContentEl.innerHTML = captureHTML + nonCaptureHTML;
                    modal.style.display = 'flex';
                    
                    modalContentEl.querySelectorAll('.update-btn').forEach(button => {
                        const newButton = button.cloneNode(true);
                        button.parentNode.replaceChild(newButton, button);
                        newButton.addEventListener('click', handleModalButtonClick);
                    });

                    newSaveModalBtn.addEventListener('click', () => {
                        const captureSec = document.getElementById('captureSection');
                        if (!captureSec) { showToast('ইনভয়েস অংশ নেই।', 'error'); return; }
                        html2canvas(captureSec, { scale: 2, useCORS: true, backgroundColor: '#ffffff' })
                        .then(canvas => {
                            const margin = 20;
                            const newCvs = document.createElement('canvas');
                            newCvs.width = canvas.width + margin * 2;
                            newCvs.height = canvas.height + margin * 2;
                            const ctx = newCvs.getContext('2d');
                            ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, newCvs.width, newCvs.height);
                            ctx.drawImage(canvas, margin, margin);
                            const link = document.createElement('a');
                            link.download = `Order-${order.orderId || 'details'}.png`;
                            link.href = newCvs.toDataURL('image/png');
                            link.click();
                            showToast('ইনভয়েস ডাউনলোড হয়েছে!');
                        }).catch(err => {
                            console.error("ইনভয়েস ক্যাপচার সমস্যা:", err);
                            showToast('ইনভয়েস ডাউনলোড সমস্যা।', 'error');
                        });
                    });

                } else {
                    showToast("অর্ডারের বিস্তারিত নেই।", 'error');
                    modal.style.display = 'none';
                }
            }, (error) => {
                console.error("অর্ডারের বিস্তারিত লোড সমস্যা:", error);
                showToast("অর্ডারের বিস্তারিত লোড সমস্যা।", 'error');
                modal.style.display = 'none';
            });
        }

        function handleModalButtonClick(e) {
            const orderId = e.target.dataset.orderId;
            const action = e.target.dataset.action;
            if (action === 'add-note') addAdminNote(orderId);
            else updateOrderStatus(orderId);
        }

        function getStatusText(status) {
            const statuses = {
                processing: 'প্রসেসিং', confirmed: 'কনফার্মড', packaging: 'প্যাকেজিং',
                shipped: 'ডেলিভারি হয়েছে', delivered: 'সম্পন্ন হয়েছে',
                failed: 'ব্যর্থ', cancelled: 'ক্যানসেলড'
            };
            return statuses[status] || 'অজানা';
        }
    </script>
    <!-- সোশ্যাল মিডিয়া ফ্লোটিং বাটন -->
    <div class="fixed bottom-4 right-4 z-50">
        <!-- শেয়ার বাটন -->
        <button id="shareButton" class="bg-lipstick text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center">
            <i class="fas fa-user-circle"></i>
        </button>
        <!-- সোশ্যাল মিডিয়া আইকনগুলি (লুকানো অবস্থায়) -->
        <div id="socialIcons" class="hidden space-y-2 mt-2">
            <a href="https://www.facebook.com/share/1PyLUzGE9P/" class="bg-lipstick text-white w-10 h-10 rounded-full flex items-center justify-center">
                <i class="fab fa-facebook"></i>
            </a>
            <a href="https://www.instagram.com/anysbeautycorner/?utm_medium=copy_link" class="bg-lipstick text-white w-10 h-10 rounded-full flex items-center justify-center">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://www.tiktok.com/@anysbeautycorner" class="bg-lipstick text-white w-10 h-10 rounded-full flex items-center justify-center">
                <i class="fab fa-tiktok"></i>
            </a>
            <a href="https://youtube.com/@anysbeautycorner?si=oXGtEuakP_SIPH_Q" class="bg-lipstick text-white w-10 h-10 rounded-full flex items-center justify-center">
                <i class="fab fa-youtube"></i>
            </a>
        </div>
    </div>

    <!-- সোশ্যাল মিডিয়া শেয়ার বাটনের জন্য স্ক্রিপ্ট -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const shareButton = document.getElementById('shareButton');
            const socialIcons = document.getElementById('socialIcons');

            if (shareButton && socialIcons) {
                shareButton.addEventListener('click', () => {
                    socialIcons.classList.toggle('hidden');
                });

                // বাইরে ক্লিক করলে সোশ্যাল আইকন বন্ধ হবে
                document.addEventListener('click', (event) => {
                    if (!shareButton.contains(event.target) && !socialIcons.contains(event.target)) {
                        socialIcons.classList.add('hidden');
                    }
                });
            }
        });
    </script>
</body>
</html>