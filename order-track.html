<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অর্ডার ট্র্যাক - Any's Beauty Corner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .step-item .step-connector { z-index: -1; }
        .modal { display: none; }
        .modal.flex { display: flex; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- হেডার -->
    <div id="header"></div>

    <!-- মেইন কন্টেন্ট -->
    <div class="container mx-auto pt-20 pb-8 px-4 min-h-screen">
        <h1 class="text-3xl font-bold text-center mb-8 text-lipstick">আপনার অর্ডারসমূহ</h1>
        
        <!-- অর্ডার লিস্ট -->
        <div id="orderListContainer">
            <div id="orderList" class="bg-white rounded-lg shadow-md">
                <!-- লোডিং বা অর্ডার লিস্ট এখানে দেখানো হবে -->
            </div>
        </div>
    </div>

    <!-- মডাল এবং ফুটার অপরিবর্তিত -->
    <div id="orderModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[2000] items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto relative p-6">
            <span id="modalClose" class="absolute top-2 right-4 text-3xl text-gray-500 cursor-pointer">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    <div id="footer"></div>

    <!-- Firebase এবং স্ক্রিপ্ট -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVSzQS1c7H4BLhsDF_fW8wnqUN4B35LPA",
            authDomain: "nahid-6714.firebaseapp.com",
            databaseURL: "https://nahid-6714-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nahid-6714",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        const orderListDiv = document.getElementById('orderList');

        async function fetchOrders(user) {
            orderListDiv.innerHTML = '<p class="text-center text-gray-500 italic p-8">আপনার অর্ডারগুলো লোড হচ্ছে...</p>';
            let orderIds = [];
            
            try {
                if (user) {
                    // লগইন করা থাকলে, তার প্রোফাইল থেকে অর্ডারের আইডিগুলো আনা হবে
                    const historyRef = ref(database, `users/${user.uid}/orderHistory`);
                    const snapshot = await get(historyRef);
                    if (snapshot.exists()) {
                        orderIds = Object.keys(snapshot.val());
                    }
                } else {
                    // গেস্ট হলে লোকাল স্টোরেজ থেকে আইডিগুলো আনা হবে
                    orderIds = JSON.parse(localStorage.getItem('myOrders') || '[]');
                }

                if (orderIds.length === 0) {
                    displayOrdersAsCards([]);
                    return;
                }

                // প্রতিটি আইডি দিয়ে একটি একটি করে অর্ডার আনা হবে (এটি security rules অনুযায়ী নিরাপদ)
                const orderPromises = orderIds.map(id => get(ref(database, `orders/${id}`)));
                const orderSnapshots = await Promise.all(orderPromises);
                const allOrders = orderSnapshots
                    .filter(s => s.exists())
                    .map(s => ({ key: s.key, ...s.val() }));

                allOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                displayOrdersAsCards(allOrders);

            } catch (error) {
                console.error("Order fetch failed:", error);
                orderListDiv.innerHTML = '<p class="text-center text-red-500 p-8">দুঃখিত, অর্ডার লোড করা সম্ভব হয়নি।</p>';
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const headerRes = await fetch('header.html');
            document.getElementById('header').innerHTML = await headerRes.text();
            const footerRes = await fetch('footer.html');
            document.getElementById('footer').innerHTML = await footerRes.text();
            
            onAuthStateChanged(auth, fetchOrders);
        });
        
        // --- বাকি হেল্পার ফাংশনগুলো অপরিবর্তিত ---
        function displayOrdersAsCards(orders) { /* আগের মতোই */ 
            if (!orders || orders.length === 0) {
                orderListDiv.innerHTML = '<p class="text-center text-gray-600 p-8">আপনি এখনো কোনো অর্ডার করেননি।</p>';
                return;
            }
            orderListDiv.innerHTML = `<div class="hidden md:grid grid-cols-4 gap-4 font-bold p-4 bg-gray-100 rounded-t-lg text-sm text-gray-700"><div>অর্ডার আইডি</div><div>অর্ডারের তারিখ</div><div>মোট মূল্য</div><div>স্ট্যাটাস</div></div>`;
            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'grid grid-cols-2 md:grid-cols-4 gap-4 p-4 border-b cursor-pointer hover:bg-gray-50 text-sm items-center';
                card.innerHTML = `<div><span class="md:hidden font-semibold">আইডি: </span>${order.orderId || 'N/A'}</div><div class="hidden md:block">${order.orderDate ? new Date(order.orderDate).toLocaleString('bn-BD') : 'N/A'}</div><div><span class="md:hidden font-semibold">মূল্য: </span>${order.totalAmount || 0} টাকা</div><div class="text-right md:text-left"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(order.status)}">${getStatusText(order.status)}</span></div>`;
                card.onclick = () => showOrderDetailsModal(order);
                orderListDiv.appendChild(card);
            });
        }
        function showOrderDetailsModal(order) { /* আগের মতোই */ 
            const modal = document.getElementById('orderModal');
            const modalContent = document.getElementById('modalContent');
            const statuses = ['processing', 'confirmed', 'packaging', 'shipped', 'delivered'];
            const currentStatusIndex = statuses.indexOf(order.status || 'processing');
            let trackerHTML = '<div class="flex justify-between items-center mb-6 text-xs text-center">';
            statuses.forEach((status, index) => {
                const isActive = index <= currentStatusIndex;
                const isCompleted = index < currentStatusIndex;
                trackerHTML += `<div class="step-item flex-1 relative"><div class="step-icon w-8 h-8 mx-auto rounded-full flex items-center justify-center font-bold ${isActive ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'} transition-colors duration-300">${isCompleted ? '<i class="fas fa-check"></i>' : (index + 1)}</div><p class="mt-2 ${isActive ? 'text-green-600 font-semibold' : 'text-gray-500'}">${getStatusText(status)}</p>${ index < statuses.length - 1 ? `<div class="step-connector absolute top-4 left-1/2 w-full h-0.5 ${isCompleted ? 'bg-green-500' : 'bg-gray-200'}"></div>` : '' }</div>`;
            });
            trackerHTML += '</div>';

            let detailsHTML = `<h3 class="text-xl font-bold text-lipstick mb-4">অর্ডারের বিস্তারিত</h3>${trackerHTML}<div class="space-y-1 text-sm bg-gray-50 p-3 rounded-lg"><p><strong>অর্ডার আইডি:</strong> ${order.orderId || 'N/A'}</p><p><strong>তারিখ:</strong> ${order.orderDate ? new Date(order.orderDate).toLocaleString('bn-BD') : 'N/A'}</p><p><strong>নাম:</strong> ${order.customerName || 'N/A'}</p></div><hr class="my-3"><h4 class="font-semibold mb-2">প্রোডাক্টস</h4>`;
            (order.cartItems || []).forEach(item => {
                detailsHTML += `<div class="flex items-center mb-2 p-2 bg-gray-50 rounded-md"><img src="${item.image || 'https://via.placeholder.com/64'}" alt="${item.name}" class="w-12 h-12 object-cover rounded mr-3"><div class="text-sm flex-grow"><p class="font-semibold">${item.name}</p><p>${item.quantity} x ${item.price} টাকা</p></div><div class="text-sm font-semibold">${(item.quantity * item.price).toFixed(2)} টাকা</div></div>`;
            });
            detailsHTML += `<hr class="my-3"><div class="text-right space-y-1"><p><strong>ডেলিভারি ফি:</strong> ${order.deliveryFee || 0} টাকা</p><p class="text-lg font-bold"><strong>মোট মূল্য:</strong> ${order.totalAmount || 0} টাকা</p></div>`;

            modalContent.innerHTML = detailsHTML;
            modal.classList.add('flex');
            
            document.getElementById('modalClose').onclick = () => modal.classList.remove('flex');
            modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('flex'); };
        }
        function getStatusText(status) { const s = { processing: 'প্রসেসিং', confirmed: 'কনফার্মড', packaging: 'প্যাকেজিং', shipped: 'ডেলিভারি হয়েছে', delivered: 'সম্পন্ন হয়েছে', failed: 'ব্যর্থ', cancelled: 'ক্যানসেলড' }; return s[status] || 'প্রসেসিং'; }
        function getStatusColor(status) { const c = { processing: 'bg-yellow-100 text-yellow-800', confirmed: 'bg-blue-100 text-blue-800', packaging: 'bg-purple-100 text-purple-800', shipped: 'bg-cyan-100 text-cyan-800', delivered: 'bg-green-100 text-green-800', failed: 'bg-red-100 text-red-800', cancelled: 'bg-gray-200 text-gray-800' }; return c[status] || c.processing; }
    </script>
</body>
</html>